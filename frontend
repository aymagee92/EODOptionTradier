from flask import Flask, request, render_template_string
from sqlalchemy import create_engine, text
import os

app = Flask(__name__)
engine = create_engine(os.environ["PG_DSN"])

COLUMNS = [
    "quoteDate",
    "underlyingLast",
    "expireDate",
    "callVolume",
    "callBid",
    "callAsk",
    "callMid",
    "strike",
    "putMid",
    "putBid",
    "putAsk",
    "putVolume",
    "itmPercCalls",
    "itmPercPuts",
    "dte",
]

TABLE = "option_chain_eod"

TEMPLATE = """
<!doctype html>
<title>Options DB</title>
<h2>Database Table: {{ table }}</h2>

<form method="get">
<table border="1" cellpadding="4" cellspacing="0">
  <tr>
    {% for col in columns %}
      <th>
        {{ col }}<br>
        <input type="text" name="f_{{ col }}" value="{{ filters.get(col,'') }}" size="10"><br>
        <select name="s_{{ col }}">
          <option value="">—</option>
          <option value="asc" {% if sorts.get(col)=='asc' %}selected{% endif %}>▲</option>
          <option value="desc" {% if sorts.get(col)=='desc' %}selected{% endif %}>▼</option>
        </select>
      </th>
    {% endfor %}
  </tr>
</table>

<br>
Rows:
<input type="number" name="limit" value="{{ limit }}" min="1" max="5000">
<button type="submit">Run</button>
</form>

<hr>

<h3>Results</h3>

<table border="1" cellpadding="4" cellspacing="0">
  <tr>
    {% for col in columns %}
      <th>{{ col }}</th>
    {% endfor %}
  </tr>

  {% for row in rows %}
    <tr>
      {% for col in columns %}
        <td>{{ row.get(col) }}</td>
      {% endfor %}
    </tr>
  {% endfor %}
</table>
"""

@app.route("/", methods=["GET"])
def index():
    filters = {}
    sorts = {}
    where_clauses = []
    params = {}

    for col in COLUMNS:
        fval = request.args.get(f"f_{col}")
        sval = request.args.get(f"s_{col}")

        if fval:
            filters[col] = fval
            where_clauses.append(f"{col}::text ILIKE :f_{col}")
            params[f"f_{col}"] = f"%{fval}%"

        if sval in ("asc", "desc"):
            sorts[col] = sval

    where_sql = ""
    if where_clauses:
        where_sql = "WHERE " + " AND ".join(where_clauses)

    order_sql = ""
    if sorts:
        order_parts = [f"{col} {direction}" for col, direction in sorts.items()]
        order_sql = "ORDER BY " + ", ".join(order_parts)

    limit = int(request.args.get("limit", 100))
    params["limit"] = limit

    sql = f"""
    SELECT {",".join(COLUMNS)}
    FROM {TABLE}
    {where_sql}
    {order_sql}
    LIMIT :limit
    """

    with engine.connect() as conn:
        rows = [dict(r) for r in conn.execute(text(sql), params)]

    return render_template_string(
        TEMPLATE,
        rows=rows,
        columns=COLUMNS,
        filters=filters,
        sorts=sorts,
        limit=limit,
        table=TABLE,
    )

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
